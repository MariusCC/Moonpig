#!/usr/bin/env perl
use strict;
use warnings;
use lib 'lib';

use Moonpig::Logger '$Logger' => { init => {
  ident     => 'Moonpig::Demo',
  to_stdout => 1,
  log_pid   => 0,
  prefix    => '* ',
} };

use Moonpig::Env::Test;

use Moonpig::Events::Handler::Code;
use Moonpig::Events::Handler::Noop;

use Moonpig::Util qw(class dollars event);

Moonpig->env->stop_time;

# 1. create ledger

my $contact = class('Contact')->new({
  name => 'J. Fred Bloggs',
  email_addresses => [ 'jfred@example.com' ],
});

my $ledger = class('Ledger')->new({
  contact => $contact,
});

# 2. create consumer

my $consumer = $ledger->add_consumer(
  class(qw(Consumer::ByTime)),
  {
    cost_amount        => dollars(50),
    cost_period        => 364 * 86400,
    charge_frequency   =>   7 * 86400, # less frequent to make logs simpler
    charge_description => 'yoyodyne service',
    old_age            =>  30 * 86400,
    cost_path_prefix   => 'yoyodyne.basic',

    # XXX: I have NFI what to do here, yet. -- rjbs, 2011-01-12
    replacement_mri    => Moonpig::URI->new(
      "moonpig://test/method?method=construct_replacement"
    ),
  },
);

# 3. charge, finalize, send invoice

my $invoice = $ledger->current_invoice;

my $charge = $invoice->add_charge_at(
  class('Charge::Bankable')->new({
    description => 'yoyodyne setup',
    amount      => $consumer->cost_amount,
    consumer    => $consumer,
  }),
  'test.charges.setup',
);

$invoice->finalize_and_send;

# 4. pay and apply payment to invoice

$ledger->add_credit(
  class(qw(Credit::Simulated)),
  { amount => $invoice->total_amount },
);

$ledger->process_credits;

# 5. create and link bank to consumer

  # implicit in combination of invoice's handler and credit processing

# 6. heartbeats, until...
# 7. consumer charges bank
# 8. until low-funds, goto 6
# 9. setup replacement
# 10. funds expire
# 11a. fail over (if replacement funded)
# 11b. cancel account (if replacement unfunded)

for (1 .. 24) {
  $ledger->handle_event( event('heartbeat') );

  $Logger->log([
    "%s still has %s in it",
    $consumer->bank->ident,
    $consumer->bank->unapplied_amount,
  ]);

  Moonpig->env->elapse_time(30 * 86400);
}

